{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block content %}

<style>
  body { background:#f6f8fb; }

  .board-title{
    font-weight:700;
    color:#1f3c88;
  }

  .scrum-column{
    min-height:520px;
    border-radius:14px;
    padding:16px;
    background:#ffffff;
    box-shadow:0 8px 25px rgba(0,0,0,.06);
  }

  .column-header{
    font-weight:600;
    text-align:center;
    margin-bottom:16px;
    padding-bottom:8px;
    border-bottom:2px solid #f1f1f1;
  }

  .pending-header{ color:#dc3545; }
  .progress-header{ color:#fd7e14; }
  .completed-header{ color:#198754; }

  .task-card{
    border-radius:12px;
    background:#fff;
    border:1px solid #eaeaea;
    padding:14px;
    margin-bottom:14px;
    transition:.25s;
  }

  .task-card:hover{
    transform:translateY(-4px);
    box-shadow:0 12px 30px rgba(0,0,0,.08);
  }

  .task-title{
    font-weight:600;
    color:#212529;
  }

  .priority-badge{
    font-size:.75rem;
    padding:6px 10px;
    border-radius:20px;
  }

  .progress{
    height:6px;
    border-radius:6px;
  }

  .view-only{
    font-size:.75rem;
    color:#6c757d;
    text-align:center;
    margin-top:6px;
  }
</style>

<div class="container-fluid mt-4">

  <!-- ================= HEADER ================= -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h4 class="board-title">
      <i class="bi bi-kanban-fill"></i> Task Board
      <small class="text-muted fs-6">(Last 7 Days)</small>
    </h4>

    {% if request.user.is_superuser %}
    <div>
      <a href="{% url 'add_task_page' %}" class="btn btn-primary me-2">
        <i class="bi bi-plus-circle"></i> New Task
      </a>
      <a href="{% url 'task_history' %}" class="btn btn-outline-secondary">
        <i class="bi bi-clock-history"></i> History
      </a>
    </div>
    {% endif %}
  </div>

  <!-- ================= QUICK ASSIGN ================= -->
  {% if request.user.is_superuser %}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-primary text-white fw-semibold">
      <i class="bi bi-lightning-fill"></i> Quick Assign
    </div>
    <div class="card-body bg-light">
      <form method="POST" class="row g-3">
        {% csrf_token %}
        <div class="col-md-3">{{ form.trainer|as_crispy_field }}</div>
        <div class="col-md-3">{{ form.task|as_crispy_field }}</div>
        <div class="col-md-2">{{ form.priority|as_crispy_field }}</div>
        <div class="col-md-2">{{ form.for_date|as_crispy_field }}</divdiv>
        <div class="col-md-2 d-grid align-items-end">
          <button class="btn btn-success mt-3">
            <i class="bi bi-check-circle"></i> Assign
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- ================= BOARD ================= -->
  <div class="row g-4">

    {% for key, tasks in grouped_tasks.items %}
    <div class="col-lg-4 col-md-6">
      <div class="scrum-column">

        <!-- COLUMN HEADER -->
        {% if key == "pending" %}
          <div class="column-header pending-header">
            <i class="bi bi-hourglass-split"></i> Pending
          </div>
        {% elif key == "in_progress" %}
          <div class="column-header progress-header">
            <i class="bi bi-gear-wide-connected"></i> In Progress
          </div>
        {% else %}
          <div class="column-header completed-header">
            <i class="bi bi-check2-circle"></i> Completed
          </div>
        {% endif %}

        {% for task in tasks %}
        <div class="task-card">

          <div class="d-flex justify-content-between align-items-start">
            <span class="task-title">{{ task.task }}</span>
            <span class="badge priority-badge
              {% if task.priority == 'high' %}bg-danger
              {% elif task.priority == 'medium' %}bg-warning text-dark
              {% else %}bg-success{% endif %}">
              {{ task.get_priority_display }}
            </span>
          </div>

          <small class="text-muted d-block mt-1">
            <i class="bi bi-person"></i> {{ task.trainer.Name }} <br>
            <i class="bi bi-calendar"></i> {{ task.for_date }}
          </small>

          {% if task.total_subtasks > 0 %}
          <div class="progress mt-2">
            <div class="progress-bar
              {% if task.progress == 100 %}bg-success
              {% elif task.progress > 50 %}bg-info
              {% else %}bg-warning{% endif %}"
              style="width:{{ task.progress }}%">
            </div>
          </div>
          <small class="text-muted">
            {{ task.completed_subtasks }}/{{ task.total_subtasks }} done
          </small>
          {% else %}
          <small class="text-muted d-block mt-2">No subtasks</small>
          {% endif %}

          <!-- ACTIONS -->
          <div class="d-flex justify-content-between mt-3">
            <a href="{% url 'task_detail' task.id %}"
               class="btn btn-outline-dark btn-sm">
              <i class="bi bi-eye"></i>
            </a>

            {% if request.user.is_superuser %}
            <a href="{% url 'change_task_status' task.id %}"
               class="btn btn-outline-primary btn-sm">
              <i class="bi bi-arrow-repeat"></i>
            </a>

            <a href="{% url 'delete_task' task.id %}"
               class="btn btn-outline-danger btn-sm"
               onclick="return confirm('Delete this task?')">
              <i class="bi bi-trash"></i>
            </a>
            {% endif %}
          </div>

          {% if not request.user.is_superuser %}
            <div class="view-only">View only</div>
          {% endif %}

        </div>
        {% empty %}
        <div class="text-center text-muted mt-5">
          <i class="bi bi-inbox fs-3"></i>
          <div>No tasks</div>
        </div>
        {% endfor %}

      </div>
    </div>
    {% endfor %}

  </div>
</div>

{% endblock %}
