{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block content %}
<style>
  .scrum-column {
    min-height: 540px;
    border-radius: 12px;
    padding: 15px;
    transition: all 0.3s ease;
    box-shadow: inset 0 0 0 1px #f1f1f1;
  }
  .scrum-column.pending { background: linear-gradient(180deg, #fff5f5, #ffffff); }
  .scrum-column.in-progress { background: linear-gradient(180deg, #fff8e5, #ffffff); }
  .scrum-column.completed { background: linear-gradient(180deg, #e9fff1, #ffffff); }

  .task-card {
    border-radius: 12px;
    background: #fff;
    border: 1px solid #e9ecef;
    padding: 15px;
    transition: 0.3s;
  }
  .task-card:hover { transform: translateY(-3px); box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08); }

  .task-title { font-weight: 600; color: #212529; }
  .priority-badge { font-size: 0.8rem; border-radius: 8px; }
  .progress { height: 7px; border-radius: 5px; }
  .scrum-column h5 { letter-spacing: 0.5px; font-weight: 600; }
</style>

<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold text-primary">
      <i class="bi bi-kanban-fill"></i> Admin Task Board <small class="text-muted">(Past 7 Days)</small>
    </h4>
    <div>
      <a href="{% url 'add_task_page' %}" class="btn btn-primary me-2">
        <i class="bi bi-plus-circle"></i> Create Full Task
      </a>
      <a href="{% url 'task_history' %}" class="btn btn-outline-dark">
        <i class="bi bi-clock-history"></i> View History
      </a>
    </div>
  </div>

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <i class="bi bi-pencil-square"></i> Quick Assign Task
    </div>
    <div class="card-body bg-light">
      <form method="POST" class="row g-3">
        {% csrf_token %}
        <div class="col-md-3">{{ form.trainer|as_crispy_field }}</div>
        <div class="col-md-3">{{ form.task|as_crispy_field }}</div>
        <div class="col-md-2">{{ form.priority|as_crispy_field }}</div>
        <div class="col-md-2">{{ form.for_date|as_crispy_field }}</div>
        <div class="col-md-2 d-grid align-items-end">
          <button type="submit" name="add_task" class="btn btn-light border mt-3 fw-semibold">
            <i class="bi bi-check2-circle text-primary"></i> Assign
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-4">
    {% for key, tasks in grouped_tasks.items %}
    <div class="col-md-4">
      <div class="scrum-column 
        {% if key == 'pending' %}pending
        {% elif key == 'in_progress' %}in-progress
        {% else %}completed{% endif %}">
        
        <div class="text-center mb-3">
          {% if key == 'pending' %}
            <h5 class="text-danger"><i class="bi bi-hourglass-split"></i> Pending</h5>
          {% elif key == 'in_progress' %}
            <h5 class="text-warning"><i class="bi bi-gear-wide-connected"></i> In Progress</h5>
          {% else %}
            <h5 class="text-success"><i class="bi bi-check2-all"></i> Completed</h5>
          {% endif %}
        </div>

        {% if tasks %}
          {% for task in tasks %}
          <div class="task-card mb-3">
            <div class="d-flex justify-content-between align-items-start">
              <span class="task-title">{{ task.task }}</span>
              <span class="badge priority-badge 
                {% if task.priority == 'high' %}bg-danger
                {% elif task.priority == 'medium' %}bg-warning text-dark
                {% else %}bg-success{% endif %}">
                {{ task.get_priority_display }}
              </span>
            </div>

            <small class="text-muted d-block mt-1">
              <i class="bi bi-person-circle"></i> {{ task.trainer.Name }} <br>
              <i class="bi bi-calendar3"></i> {{ task.for_date }}
            </small>

            <!-- Subtask Progress -->
            {% if task.total_subtasks > 0 %}
              <div class="progress mt-2">
                <div class="progress-bar 
                    {% if task.progress == 100 %}bg-success
                    {% elif task.progress > 50 %}bg-info
                    {% else %}bg-warning{% endif %}"
                    role="progressbar"
                    style="width: {{ task.progress }}%">
                </div>
              </div>
              <small class="text-muted">
                {{ task.completed_subtasks }}/{{ task.total_subtasks }} subtasks done ({{ task.progress }}%)
              </small>
            {% else %}
              <small class="text-muted d-block mt-1">No subtasks</small>
            {% endif %}

            <!-- Buttons -->
<div class="d-flex justify-content-between mt-3">

  <!-- View -->
  <a href="{% url 'task_detail' task.id %}"
     class="btn btn-outline-dark btn-sm"
     title="View Details">
    <i class="bi bi-eye"></i>
  </a>

  <!-- Change Status -->
  <a href="{% url 'change_task_status' task.id %}"
     class="btn btn-outline-primary btn-sm"
     title="Change Status">
    <i class="bi bi-arrow-repeat"></i>
  </a>

  <!-- Delete -->
  <a href="{% url 'delete_task' task.id %}"
     class="btn btn-outline-danger btn-sm"
     onclick="return confirm('Delete this task?')">
    <i class="bi bi-trash"></i>
  </a>

</div>

          </div>
          {% endfor %}
        {% else %}
          <div class="text-center text-muted mt-5">
            <i class="bi bi-inbox fs-3 d-block"></i>
            <small>No tasks here</small>
          </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
